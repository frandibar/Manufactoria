digraph {
    write_end_flag;
    read_first;
    last_is_blue;
    last_is_red;
    blue_to_front;
    red_to_front;
    rewrite_until_end;
    rewrite_blue;
    rewrite_red;
    read_2nd_after_blue;
    read_2nd_after_red;
    write_blue_and_read_after_blue;
    write_blue_and_read_after_red;
    write_red_and_read_after_blue;
    write_red_and_read_after_red;
    accept;

    write_end_flag->read_first;
    read_first->read_2nd_after_blue[label="blue"];
    read_first->read_2nd_after_red[label="red"];
    read_first->accept[label="else"];
    last_is_blue->blue_to_front;
    last_is_red->red_to_front;
    blue_to_front->rewrite_until_end;
    red_to_front->rewrite_until_end;
    rewrite_until_end->rewrite_blue[label="blue"];
    rewrite_until_end->rewrite_red[label="red"];
    rewrite_until_end->accept;
    rewrite_blue->rewrite_until_end;
    rewrite_red->rewrite_until_end;
    read_2nd_after_blue->write_blue_and_read_after_blue[label="blue"];
    read_2nd_after_blue->write_blue_and_read_after_red[label="red"];
    read_2nd_after_blue->last_is_blue[label="else"];
    read_2nd_after_red->write_red_and_read_after_blue[label="blue"];
    read_2nd_after_red->write_red_and_read_after_red[label="red"];
    read_2nd_after_red->last_is_red;
    write_blue_and_read_after_blue->read_2nd_after_blue;
    write_blue_and_read_after_red->read_2nd_after_red;
    write_red_and_read_after_blue->read_2nd_after_blue;
    write_red_and_read_after_red->read_2nd_after_red;
}    
